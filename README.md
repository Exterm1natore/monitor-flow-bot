# Система доставки уведомлений о событиях компьютерных инцидентов Zabbix в чат VK Teams

Проект представляет собой программный комплекс, предназначенный для автоматической доставки уведомлений от системы мониторинга Zabbix в чат VK Teams. Уведомления передаются через HTTP-запросы по протоколу webhook.

Решение включает в себя модули для получения данных от системы мониторинга, интеграции с чатами VK Teams посредством бота, а также компоненты для предварительной настройки и расширения функциональности. Дополнительно используются утилиты для форматирования текста, обработки JSON-данных, работы с датой и временем, а также преобразования информации в формат списков ORM-моделей. Все данные сохраняются в базе данных SQLite, которая обеспечивает внутреннюю регистрацию и хранение информации.

После получения события от Zabbix через webhook приложение обрабатывает его, формирует итоговое сообщение и отправляет его в чат VK Teams всем подписчикам уведомлений от системы мониторинга. Взаимодействие с системой осуществляется через чат-бота. Пользователи отправляют команды в чат, каждая из которых запускает определённый сценарий обработки или настройки.

---

## Инструкция по развёртыванию и запуску приложения

### Предисловие

Для обеспечения удобства и универсальности в проекте используется система контроля версий базы данных с помощью Alembic. Конфигурационные параметры задаются через отдельный файл с расширением `.env`, который необходимо создать и заполнить в соответствии с описанными ниже требованиями. Этот файл служит источником всех ключевых настроек, необходимых для запуска и работы приложения.

### Инструкция

1. Установите интерпретатор Python версии 3.6.8.

2. Установите зависимости, указанные в файле `requirements.txt`:
```
pip install -r requirements.txt
```

3. Создайте переменную окружения `.env` в корневой папке проекта и установите следующие параметры:
	- `ENV_PATH` - содержит путь к внешней переменной окружения `.env`, в которой находятся все указанные ниже параметры. Не является обязательной к добавлению, при условии, что все параметры установлены в текущей переменной окружения. При установке `ENV_PATH` параметры берутся по указанному пути в этом параметре, а остальные параметры не загружаются в приложение из текущей переменной.
	
	- `LOG_DIRECTORY` - содержит путь к директории, в которой будут храниться файлы логов приложения.
	
	- `VKTEAMS_BOT_TOKEN` - содержит токен бота VK Teams.
	
	- `DB_PATH` - содержит путь к файлу базы данных SQLite.
	
	- `WEBHOOK_EVENT_ENDPOINT` - содержит путь конечной точки webhook, принимающей события от системы мониторинга (должен начинаться с `/`).
	
	- `API_HOST` - содержит адрес, на котором будет запущен FastAPI-сервер. Стандартным значением можно указать `0.0.0.0`.
	
	- `API_PORT` - содержит порт для запуска FastAPI-сервера. Укажите положительное целое число. Стандартным значением можно указать `5000`.
	
	- `EXECUTOR_CPU_LIMIT` - содержит число выделяемых логических ядер CPU.  Укажите положительное целое число. Не рекомендуется указывать полное количество доступных ядер — лучше выбрать умеренное значение. Значение используется для настройки поточности рассылок.
	
	- `EXECUTOR_SCALING_FACTOR` - содержит коэффициент масштабирования, определяющий, сколько потоков будет выделено на одно ядро. Это должно быть положительное число с плавающей точкой. Не рекомендует указывать высокое значение. Стандартным значением можно указать `5.0`.

4. Создайте и примените миграции для локальной базы данных. Для этого выполните команду :
```
alembic upgrade head
```

5. Запустите главный управляющий скрипт:
```
python main.py
```

6. В Zabbix настройте новый **media type** с типом **webhook**, указав URL, соответствующий переменной `WEBHOOK_EVENT_ENDPOINT`. В теле запроса должна передаваться строка с информацией о событии. Метод запроса — `POST`.

7. Создайте **action trigger** в Zabbix, который будет реагировать на нужные события и использовать настроенный media type. В поле `Send only to` выберите тот media type, который вы настроили на предыдущем шаге.

---

## Контакты поддержки

Разработчик: Дорохов И.А.
Почта: iliadorox@gmail.com

При обращении указывайте версию проекта (commit hash).

---

## Используемые зависимости

  - `fastapi`, `uvicorn` — веб-сервер и API-интерфейс на базе ASGI;
  - `SQLAlchemy`, `alembic` — ORM и управление миграциями;
  - `mailru-im-bot` — интерфейс VK Teams бота;
  - `python-dotenv` — загрузка настроек из `.env` файлов;
  - `python-dateutil`, `pytz` — работа с временными зонами и форматами дат;
  - `pytest` — тестирование и настройка окружения;
  - `ratelimiter`, `tenacity` — контроль частоты запросов и повторные попытки при ошибках;
  - `pybreaker` — реализация Circuit Breaker;
  - `requests` - обработка HTTP-запросов.

---

## Описание сокращений и стандарта ведения репозитория

В процессе разработки используется система контроля версий Git с моделью ветвления Feature Branch Workflow. Все изменения производятся в отдельных ветках и объединяются через merge. Каждая фиксация должна содержать тег, указывающий на назначение коммита, в следующем формате:

```
<тег>: <сообщение>
```

Доступные теги:
- `chore` — рутинные или технические изменения;
- `init` — инициализация проекта;
- `feat` — добавление нового функционала;
- `fix` — исправление ошибок;
- `refactor` — реорганизация кода без изменения поведения;
- `style` — исправления, не влияющие на функциональность (форматирование, отступы);
- `test` — добавление или изменение тестов;
- `docs` — изменение/добавление документации;
- `perf` — улучшения производительности;
- `ci` — настройка CI/CD или скриптов сборки;
- `sec` — изменения, связанные с безопасностью;
- `revert` — откат к предыдущему коммиту;
- `build` — изменения, влияющие на сборку или зависимости.

Примеры коммитов:
- `feat: add notifications for administrators`
- `fix: fix access to ORM models outside of session`
- `refactor: improving readability of output text`
- `build: configure Alembic for database migrations`
- `docs: added README.md`
- `chore: added .gitignore`

---

_Разработка ориентирована на локальное использование внутри организации. Требует доступа к платформе VK Teams._
